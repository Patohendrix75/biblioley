<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>Biblioteca Jurídica – ANF</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root { --primary:#1f334d;--bg:#f5f7fa;--text:#333;--card-bg:#fff;--radius:12px;--shadow:0 2px 10px rgba(0,0,0,0.08); }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Ubuntu,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100vh;overflow:hidden;}
    header{background:var(--primary);color:#fff;padding:1rem;display:flex;align-items:center;}
    header h1{font-size:1.4rem;margin:0;flex:1;}
    header .home-btn{color:#fff;background:rgba(255,255,255,0.2);border:none;border-radius:var(--radius);padding:0.4rem 0.8rem;display:flex;align-items:center;gap:0.5rem;cursor:pointer;font-size:0.9rem;}
    header .home-btn:hover{background:rgba(255,255,255,0.3);}
    .toolbar{display:flex;align-items:center;justify-content:space-between;background:#e8ebf0;padding:0.75rem;}
    .search-bar{flex:1;display:flex;align-items:center;background:#fff;border-radius:50px;padding:0.5rem 1rem;box-shadow:var(--shadow);margin-right:1rem;}
    .search-bar .fa-magnifying-glass{margin-right:0.5rem;color:#666;}
    .search-bar input{flex:1;border:none;outline:none;font-size:1rem;background:transparent;}
    .view-btns button{background:rgba(255,255,255,0.8);border:none;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);color:var(--primary);margin-right:0.5rem;cursor:pointer;}
    .view-btns button.active{background:var(--primary);color:#fff;}
    select.cat-filter{padding:0.3rem 0.6rem;border:1px solid #ccc;border-radius:8px;font-size:0.9rem;}
    main{flex:1;overflow-y:auto;padding:0.75rem;position:relative;}
    .doc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0.75rem;}
    .doc-list{display:flex;flex-direction:column;gap:0.5rem;}
    .doc-item{background:var(--card-bg);border-radius:var(--radius);padding:1.25rem 0.75rem;display:flex;flex-direction:column;align-items:center;box-shadow:var(--shadow);border-top:4px solid var(--primary);cursor:pointer;transition:transform 0.2s, box-shadow 0.2s;}
    .doc-item:hover{transform:translateY(-3px);box-shadow:0 4px 15px rgba(0,0,0,0.1);}
    .doc-icon{font-size:2rem;color:var(--primary);margin-bottom:0.75rem;}
    .doc-title{font-weight:600;text-align:center;font-size:0.9rem;line-height:1.3;}
    .doc-category{font-size:0.8rem;color:#666;margin-top:0.5rem;text-align:center;}
    #minutas-viewer{display:none;background:#fff;padding:1rem;border-radius:var(--radius);box-shadow:var(--shadow);overflow-y:auto;height:100%;}
    .back-btn{position:absolute;top:1rem;right:1rem;background:var(--primary);color:#fff;border:none;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);cursor:pointer;z-index:10;}
    .back-btn:hover{background:#2a4360;}
    .highlight{background:#ffe169;padding:0 2px;border-radius:2px;}
    .search-results{position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);background:var(--primary);color:#fff;display:flex;align-items:center;gap:0.5rem;padding:0.5rem;border-radius:50px;box-shadow:var(--shadow);display:none;}
    .search-results button{background:rgba(255,255,255,0.2);border:none;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;color:#fff;cursor:pointer;}
    .loading-overlay{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.8);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:100;display:none;}
    .loading-spinner{border:4px solid rgba(0,0,0,0.1);border-left:4px solid var(--primary);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin-bottom:1rem;}
    .error-message{background:#fff;border-left:4px solid #ff4136;padding:1rem;border-radius:var(--radius);margin:1rem 0;display:none;}
    @keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
  </style>
</head>
<body>
  <header>
    <h1>Minutas de Jurisprudencia</h1>
    <button id="home-btn" class="home-btn"><i class="fa-solid fa-house"></i> Inicio</button>
  </header>
  <div class="toolbar">
    <div class="search-bar">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input id="minutas-search" type="text" placeholder="Buscar en minutas..."/>
    </div>
    <div class="view-btns">
      <button id="minutas-grid-btn" class="active" title="Vista en cuadrícula"><i class="fa-solid fa-table-cells"></i></button>
      <button id="minutas-list-btn" title="Vista en lista"><i class="fa-solid fa-list"></i></button>
    </div>
    <select id="minutas-catFilter" class="cat-filter">
      <option value="all">Todas las categorías</option>
      <option value="Control de Identidad">Control de Identidad</option>
      <option value="Detención y Aprehensión">Detención y Aprehensión</option>
      <option value="Diligencias e Investigación">Diligencias e Investigación</option>
      <option value="Evidencia y Cadena de Custodia">Evidencia y Cadena de Custodia</option>
      <option value="Procedimiento y Garantías">Procedimiento y Garantías</option>
      <option value="Delitos y Tipicidad">Delitos y Tipicidad</option>
    </select>
  </div>
  <main>
    <div id="minutas-docList" class="doc-grid"></div>
    <div id="minutas-viewer"></div>
    <button id="back-btn" class="back-btn" style="display:none;"><i class="fa-solid fa-arrow-left"></i></button>
    <div class="loading-overlay" id="loading-overlay">
      <div class="loading-spinner"></div>
      <p>Cargando documento...</p>
    </div>
    <div class="error-message" id="error-message">
      <h3>Error al cargar el documento</h3>
      <p>No se ha podido cargar el documento solicitado. Por favor, intente nuevamente más tarde.</p>
    </div>
  </main>
  <div id="minutas-search-results" class="search-results">
    <button id="minutas-prev"><i class="fa-solid fa-chevron-up"></i></button>
    <span id="minutas-counter">0 de 0</span>
    <button id="minutas-next"><i class="fa-solid fa-chevron-down"></i></button>
    <button id="minutas-close"><i class="fa-solid fa-xmark"></i></button>
  </div>
  <script>
  (function(){
    // Metadatos de las minutas con sus categorías
    let docs = [];

    // Referencias a elementos del DOM
    const docListEl = document.getElementById('minutas-docList');
    const viewerEl = document.getElementById('minutas-viewer');
    const searchEl = document.getElementById('minutas-search');
    const gridBtn = document.getElementById('minutas-grid-btn');
    const listBtn = document.getElementById('minutas-list-btn');
    const filterEl = document.getElementById('minutas-catFilter');
    const backBtn = document.getElementById('back-btn');
    const homeBtn = document.getElementById('home-btn');
    const prevEl = document.getElementById('minutas-prev');
    const nextEl = document.getElementById('minutas-next');
    const closeEl = document.getElementById('minutas-close');
    const counterEl = document.getElementById('minutas-counter');
    const loadingOverlay = document.getElementById('loading-overlay');
    const errorMessage = document.getElementById('error-message');

    // Variables globales
    let highlights = [], currentHit = 0;
    let currentDocument = null;
    let appState = 'home'; // Puede ser 'home' o 'viewer'

    async function fetchDocumentList() {
      let response = await fetch('/list_project_files');
        const data = await response.json();
        const files = data.result;
        const filteredFiles = files.filter(file => file.startsWith('minutas/') && file.endsWith('.md'));
      try {
          docs = filteredFiles.map(file => {
            const fileName = file.split('/').pop().replace('.md','');
            const num = fileName.split('_')[0];
            return {
                  path: `${file}`,
                  title: `Minuta Nº ${num} – ${fileName.replace(num+'_','')}`,
                  category: 'Minuta',
              };
          });
      } catch (error) {
        console.error('Error al obtener la lista de documentos:', error);
        docs = [];
    }
    }

    // Renderiza las tarjetas de documentos
    function renderDocuments() {
      docListEl.innerHTML = '';
      const selectedCategory = filterEl.value;
      fetchDocumentList();
      const filteredDocs = docs

      // Si no hay documentos, mostrar mensaje
      if (filteredDocs.length === 0) {
        docListEl.innerHTML = '<div class="no-results">No se encontraron documentos en esta categoría.</div>';
        return;
      }
      
      // Crear tarjetas para cada documento
      filteredDocs.forEach(doc => {
        const card = document.createElement('div');
        card.className = 'doc-item';
        card.innerHTML = `
          <div class="doc-icon"><i class="fa-solid fa-file-lines"></i></div>
          <div class="doc-title">${doc.title}</div>
          <div class="doc-category">${doc.category}</div>
        `;
        card.addEventListener('click', () => openDocument(doc));
        docListEl.appendChild(card);
      });
      
      // Aplicar modo de vista (cuadrícula o lista)
      applyViewMode();
    }

    // Cambia entre vista de cuadrícula y lista
    function applyViewMode() {
      docListEl.className = gridBtn.classList.contains('active') ? 'doc-grid' : 'doc-list';
    }

    // Abre un documento para su visualización
    async function openDocument(doc) {
      try {
        // Cambia el estado y muestra la pantalla de carga
        appState = 'viewer';
        currentDocument = doc;
        docListEl.style.display = 'none';
        viewerEl.style.display = 'block';
        backBtn.style.display = 'flex';
        loadingOverlay.style.display = 'flex';
        errorMessage.style.display = 'none';
        
        // Intenta cargar el documento
        const response = await fetch(doc.path);
        
        // Verifica si la respuesta fue exitosa
        if (!response.ok) {
          throw new Error(`Error al cargar: ${response.status} ${response.statusText}`);
        }
        
        // Procesa el contenido del documento
        const markdownText = await response.text();
        const htmlContent = marked.parse(markdownText);
        
        // Actualiza el visor
        viewerEl.innerHTML = `<h1>${doc.title}</h1>${htmlContent}`;
        viewerEl.dataset.original = viewerEl.innerHTML;
        
        // Aplica resaltado de sintaxis si está disponible
        if (window.hljs) {
          window.hljs.highlightAll();
        }
      } catch (error) {
        console.error('Error al cargar el documento:', error);
        errorMessage.style.display = 'block';
      } finally {
        loadingOverlay.style.display = 'none';
      }
    }

    // Vuelve a la vista de inicio/lista de documentos
    function goToHome() {
      appState = 'home';
      currentDocument = null;
      docListEl.style.display = 'grid';
      viewerEl.style.display = 'none';
      backBtn.style.display = 'none';
      document.getElementById('minutas-search-results').style.display = 'none';
      errorMessage.style.display = 'none';
      
      // Restaura el modo de vista
      applyViewMode();
      
      // Limpia la búsqueda
      searchEl.value = '';
    }

    // Busca texto dentro del documento actual
    function searchInDocument() {
      const searchTerm = searchEl.value.trim();
      
      // Si no hay término o no estamos en modo visor, salir
      if (!searchTerm || appState !== 'viewer') {
        document.getElementById('minutas-search-results').style.display = 'none';
        return;
      }
      
      // Restaura el contenido original
      viewerEl.innerHTML = viewerEl.dataset.original;
      
      // Crea expresión regular para buscar
      try {
        const regex = new RegExp(`(${searchTerm})`, 'gi');
        // Encuentra todas las coincidencias
        const content = viewerEl.innerHTML;
        const matches = Array.from(content.matchAll(regex));
        
        if (matches.length > 0) {
          highlights = matches.map(m => m[0]);
          
          // Resalta las coincidencias
          viewerEl.innerHTML = content.replace(regex, '<span class="highlight">$1</span>');
          
          // Muestra los resultados y se desplaza al primero
          const highlightedElements = viewerEl.querySelectorAll('.highlight');
          if (highlightedElements.length) {
            currentHit = 0;
            highlightedElements[currentHit].scrollIntoView({ 
              behavior: 'smooth', 
              block: 'center' 
            });
            
            // Actualiza el contador
            counterEl.textContent = `${currentHit + 1} de ${highlightedElements.length}`;
            document.getElementById('minutas-search-results').style.display = 'flex';
          }
        } else {
          // No se encontraron coincidencias
          document.getElementById('minutas-search-results').style.display = 'none';
        }
      } catch (error) {
        console.error('Error en la búsqueda:', error);
      }
    }

    // Navega entre las coincidencias de búsqueda
    function navigateSearchResults(direction) {
      const highlightedElements = viewerEl.querySelectorAll('.highlight');
      if (!highlightedElements.length) return;
      
      // Calcula el nuevo índice con wrap-around
      currentHit = (currentHit + direction + highlightedElements.length) % highlightedElements.length;
      
      // Desplaza a la coincidencia actual
      highlightedElements[currentHit].scrollIntoView({ 
        behavior: 'smooth', 
        block: 'center' 
      });
      
      // Actualiza el contador
      counterEl.textContent = `${currentHit + 1} de ${highlightedElements.length}`;
    }

    // Cierra la búsqueda
    function closeSearch() {
      // Restaura el contenido original
      if (viewerEl.dataset.original) {
        viewerEl.innerHTML = viewerEl.dataset.original;
      }
      
      // Restablece variables y oculta el contador
      highlights = [];
      document.getElementById('minutas-search-results').style.display = 'none';
    }

    // Configurar manejadores de eventos
    function setupEventListeners() {
      // Botones de navegación
      backBtn.addEventListener('click', goToHome);
      homeBtn.addEventListener('click', goToHome);
      
      // Cambio de vista
      gridBtn.addEventListener('click', () => {
        gridBtn.classList.add('active');
        listBtn.classList.remove('active');
        applyViewMode();
      });
      
      listBtn.addEventListener('click', () => {
        listBtn.classList.add('active');
        gridBtn.classList.remove('active');
        applyViewMode();
      });
      
      // Filtrado por categorías
      filterEl.addEventListener('change', renderDocuments);
      
      // Búsqueda
      let searchTimeout;
      searchEl.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(searchInDocument, 300);
      });
      
      // Navegación en resultados de búsqueda
      prevEl.addEventListener('click', () => navigateSearchResults(-1));
      nextEl.addEventListener('click', () => navigateSearchResults(1));
      closeEl.addEventListener('click', closeSearch);
      
      // Teclas de atajo
      document.addEventListener('keydown', (e) => {
        // Escape para volver al inicio o cerrar búsqueda
        if (e.key === 'Escape') {
          if (document.getElementById('minutas-search-results').style.display === 'flex') {
            closeSearch();
          } else if (appState === 'viewer') {
            goToHome();
          }
        }
        
        // Ctrl+F para enfocar la búsqueda
        if (e.key === 'f' && (e.ctrlKey || e.metaKey)) {
          e.preventDefault();
          searchEl.focus();
        }
      });
    }

    // Inicialización
    function init() {
      setupEventListeners();
      renderDocuments()
    }

    // Ejecutar cuando el DOM esté completamente cargado
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
  </script>
</body>
</html>