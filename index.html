<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Biblioteca Jurídica – ANF</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root { --primary:#1f334d;--accent-calc:#2a5d68;--accent-min:#8e44ad;--bg:#f5f7fa;--text:#333;--card-bg:#fff;--radius:12px;--shadow:0 2px 10px rgba(0,0,0,0.08); }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Ubuntu,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100vh;overflow:hidden;}
    header{background:var(--primary);color:#fff;padding:1rem;}
    .title-bar{display:flex;align-items:center;}
    .title-bar h1{flex:1;font-size:1.6rem;}
    .search-bar{background:#fff;border-radius:50px;padding:0.5rem 1rem;display:flex;align-items:center;box-shadow:var(--shadow);margin-top:0.5rem;}
    .search-bar .fa-magnifying-glass{margin-right:0.5rem;color:#666;}
    .search-bar input{flex:1;border:none;outline:none;font-size:1rem;background:transparent;}
    .toolbar{display:flex;align-items:center;justify-content:space-between;background:#e8ebf0;padding:0.5rem 1rem;}
    .btn{background:rgba(255,255,255,0.8);border:none;border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);color:var(--primary);cursor:pointer;}
    .btn.active{background:var(--primary);color:#fff;}
    .container{flex:1;overflow-y:auto;padding:1rem;}
    .doc-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;}
    .doc-list{display:flex;flex-direction:column;gap:0.5rem;}
    .doc-item{background:var(--card-bg);border-radius:var(--radius);padding:0.75rem;display:flex;flex-direction:column;align-items:center;box-shadow:var(--shadow);border-top:4px solid var(--primary);cursor:pointer;}
    .doc-list .doc-item{padding:0.5rem;}
    .doc-icon{font-size:1.8rem;margin-bottom:0.5rem;}
    .doc-title{font-weight:600;text-align:center;font-size:1rem;}
    #viewer{display:none;flex:1;padding:1rem;background:#fff;overflow-y:auto;}
    #doc-toolbar{display:none;align-items:center;gap:0.5rem;background:#e8ebf0;padding:0.5rem 1rem;}
    #doc-toolbar .btn{margin-right:0.5rem;}
    .search-results{display:none;position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);background:var(--primary);color:#fff;padding:0.5rem;border-radius:50px;align-items:center;gap:0.5rem;box-shadow:var(--shadow);z-index:1000;}
    .search-results button{background:rgba(255,255,255,0.2);border:none;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;color:#fff;}
    /* Estilos específicos para los resaltados de búsqueda */
    mark.highlight{background-color:yellow;color:black;}
    mark.highlight.current{background-color:orange;color:black;}
  </style>
</head>
<body>
  <header id="main-header">
    <div class="title-bar">
      <h1>Biblioteca Jurídica</h1>
      <span id="doc-title-header"></span>
    </div>
    <div class="search-bar">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input id="search" type="text" placeholder="Buscar..." />
    </div>
  </header>
  <div class="toolbar" id="view-toolbar">
    <button class="btn active" id="grid-view-btn" title="Vista cuadrícula"><i class="fa-solid fa-table-cells"></i></button>
    <button class="btn" id="list-view-btn" title="Vista lista"><i class="fa-solid fa-list"></i></button>
  </div>
  <div class="toolbar" id="doc-toolbar">
    <button class="btn" id="btn-back" title="Volver"><i class="fa-solid fa-house"></i></button>
    <button class="btn" id="btn-font-decrease" title="Reducir texto"><i class="fa-solid fa-minus"></i></button>
    <button class="btn" id="btn-font-increase" title="Aumentar texto"><i class="fa-solid fa-plus"></i></button>
  </div>
  <div class="container" id="main-container">
    <div class="doc-grid" id="docList"></div>
    <div id="minutasList" style="display:none" class="doc-grid"></div>
    <div id="viewer"></div>
  </div>
  <div class="search-results">
    <button id="prev-result"><i class="fa-solid fa-chevron-up"></i></button>
    <span id="result-counter">0 de 0</span>
    <button id="next-result"><i class="fa-solid fa-chevron-down"></i></button>
    <button id="close-search"><i class="fa-solid fa-xmark"></i></button>
  </div>
  <script>
    const docList = document.getElementById('docList');
    const minList = document.getElementById('minutasList');
    const viewer = document.getElementById('viewer');
    const searchInput = document.getElementById('search');
    const viewToolbar = document.getElementById('view-toolbar');
    const docToolbar = document.getElementById('doc-toolbar');
    const docTitleHeader = document.getElementById('doc-title-header');
    const prevBtn = document.getElementById('prev-result');
    const nextBtn = document.getElementById('next-result');
    const closeBtn = document.querySelector('.search-results #close-search');
    const counter = document.getElementById('result-counter');
    const searchResults = document.querySelector('.search-results');

    const docs = [
      { file: 'docs/documento1.html', title: 'CÓDIGO PENAL', icon: 'fa-solid fa-gavel' },
      { file: 'docs/documento2.html', title: 'CÓDIGO PROCESAL PENAL', icon: 'fa-solid fa-scale-balanced' },
      { file: 'docs/documento3.html', title: 'LEY DE DROGAS', icon: 'fa-solid fa-pills' },
      { file: 'docs/documento4.html', title: 'LEY DE CONTROL DE ARMAS', icon: 'fa-solid fa-gun' },
      { file: 'docs/documento5.html', title: 'LEY DE PENAS SUSTITUTIVAS', icon: 'fa-solid fa-person-walking-arrow-right' },
      { file: 'docs/documento6.html', title: 'LEY DE VIOLENCIA INTRAFAMILIAR', icon: 'fa-solid fa-house-user' },
      { file: 'docs/documento7.html', title: 'LEY RPA', icon: 'fa-solid fa-child' },
      { file: 'docs/documento8.html', title: 'LEY RPA (Diferida)', icon: 'fa-solid fa-child-reaching' },
      { file: 'docs/documento9.html', title: 'LEY DE VIOLENCIA EN ESTADIOS', icon: 'fa-solid fa-futbol' },
      { file: 'docs/documento10.html', title: 'LEY DE TRÁNSITO', icon: 'fa-solid fa-car' },
      { file: 'docs/documento11.html', title: 'LEY ORGÁNICA DEL MINISTERIO PÚBLICO', icon: 'fa-solid fa-building-columns' },
      { file: 'docs/calculadora_abonos.html', title: 'Calculadora Abonos por Arresto', icon: 'fa-solid fa-calculator', type: 'calc' },
      { title: 'Minutas de Jurisprudencia', icon: 'fa-solid fa-book-open', type: 'min' }
    ];
    let minutas = [];
    let highlights = [], current = -1, lastTerm = '';
    let currentFontSize = 16;
    // Para rastrear si estamos realizando una búsqueda
    let isSearching = false;

    function buildDocList() {
      docList.innerHTML = '';
      docs.forEach(d => {
        const card = document.createElement('div');
        card.className = 'doc-item';
        card.innerHTML = `<div class="doc-icon"><i class="${d.icon}"></i></div><div class="doc-title">${d.title}</div>`;
        card.onclick = () => d.type === 'min' ? showMinutas() : openDoc(d.file, d.title);
        docList.appendChild(card);
      });
    }

    async function loadMinutas() {
      try {
        // En un entorno real, esto podría ser una llamada API
        return [
          { path: 'minutas/N°2_CONTROL_DE_IDENTIDAD-LEY_DE_TRÁNSITO_C.md', title: 'N°2 - Control de identidad - Tránsito' },
          { path: 'minutas/N°3_ACCESO_A_INFORMACIÓN_EN_FACEBOOK.md', title: 'N°3 - Acceso a info Facebook' },
          { path: 'minutas/N°32_Instrucción_sobre_primeras_diligencias.md', title: 'N°32 - Primeras diligencias' }
        ];
      } catch (error) {
        console.error("Error cargando minutas:", error);
        return [];
      }
    }

    async function showMinutas() {
      docList.style.display = 'none'; 
      viewToolbar.style.display = 'none';
      minList.style.display = 'grid'; 
      minList.innerHTML = '<p>Cargando minutas...</p>';
      try {
        if (!minutas.length) minutas = await loadMinutas();
        renderMinutasList();
      } catch (error) {
        minList.innerHTML = '<p>Error al cargar las minutas. Intente nuevamente.</p>';
        console.error("Error en showMinutas:", error);
      }
    }

    function renderMinutasList() {
      minList.innerHTML = '';
      minutas.forEach(m => {
        const c = document.createElement('div');
        c.className = 'doc-item';
        c.innerHTML = `<div class="doc-icon"><i class="fa-solid fa-file-lines"></i></div><div class="doc-title">${m.title}</div>`;
        c.onclick = () => openDoc(m.path, m.title);
        minList.appendChild(c);
      });
    }

    function openDoc(path, title) {
      // Guardar el estado actual de la UI
      resetUIState();
      
      // Configurar nueva UI para visualización de documento
      docList.style.display = 'none'; 
      minList.style.display = 'none';
      viewer.style.display = 'block'; 
      viewToolbar.style.display = 'none';
      docToolbar.style.display = 'flex'; 
      docTitleHeader.textContent = title;
      
      // Detectar el tamaño de fuente guardado o usar el predeterminado
      const savedFontSize = localStorage.getItem(`fontSize-${path}`) || '1rem';
        viewer.style.fontSize = savedFontSize;
        // Establecer el tamaño actual en caso de que no se haya definido
      currentFontSize = parseFloat(savedFontSize) * 16;

      loadDocument(path);
    }    

    async function loadDocument(path) {
      viewer.innerHTML = '<p>Cargando...</p>';
      try {
        const res = await fetch(path);
        if (!res.ok) throw new Error(`Error HTTP: ${res.status}`);
        
        const txt = await res.text();
        const html = path.endsWith('.md') ? marked.parse(txt) : txt;
        
        // Almacenar el contenido original como propiedad en lugar de atributo data
        // para evitar problemas con documentos grandes
        viewer._originalContent = html;
        
        viewer.innerHTML = html;
        
        // Aplicar resaltado de código después de cargar el contenido
        setTimeout(() => {
          try {
            if(window.hljs) hljs.highlightAll();
          } catch (e) {
            console.error("Error al aplicar resaltado de sintaxis:", e);
          }
        }, 100);
      } catch (error) {
        viewer.innerHTML = `<p>Error al cargar: ${error.message}</p>`;
        
        
        
        console.error("Error cargando documento:", error);
      }
    }

    function resetUIState() {
      // Limpiar estado de búsqueda
      resetSearch();
      
      // Guardar el tamaño de fuente actual si hay un documento abierto
      if (viewer.style.display === 'block' && docTitleHeader.textContent) {
        const currentPath = docs.find(d => d.title === docTitleHeader.textContent)?.file;
        if (currentPath) {
          localStorage.setItem(`fontSize-${currentPath}`, currentFontSize);
        }
      }
    }

    function changeFont(dir) {
        
        const newSize = currentFontSize + dir * 2;
        const newSizeRem = newSize/16 + "rem";

        if (newSize !== currentFontSize) {
        currentFontSize = newSize;
        viewer.style.fontSize = newSizeRem;
        
        // Guardar el tamaño de fuente para este documento
        const currentDoc = docs.find(d => d.title === docTitleHeader.textContent);

        if (currentDoc && currentDoc.file) {
            localStorage.setItem(`fontSize-${currentDoc.file}`, newSizeRem);

        }
      }
    }    

    function resetSearch() {
      // Limpiar estado de búsqueda
      highlights = []; 
      current = -1; 
      lastTerm = '';
      isSearching = false;
      searchResults.style.display = 'none';
      
      // Si estamos en un documento, restaurar el contenido original
      if (viewer.style.display === 'block' && viewer._originalContent) {
        try {
          // Preservar el tamaño de fuente actual
          const fontSize = viewer.style.fontSize;
          viewer.innerHTML = viewer._originalContent;
          viewer.style.fontSize = fontSize;
          
          // Reaplica el resaltado de sintaxis si es necesario
          if (window.hljs) setTimeout(() => hljs.highlightAll(), 0);
        } catch (e) {
          console.error("Error restaurando contenido original:", e);
        }
      }
    }

    // Función para escapar caracteres especiales en expresiones regulares
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function doSearch() {
      const term = searchInput.value.trim();
      if (!term) {
        resetSearch();
        return;
      }
      
      if (viewer.style.display === 'block') {
        // Si ya estamos buscando y es el mismo término, solo navegamos
        if (term === lastTerm && highlights.length) {
          scrollHit(current + 1);
          return;
        }
        
        // Evitar búsquedas simultáneas
        if (isSearching) return;
        isSearching = true;
        
        try {
          // Nueva búsqueda - Restaurar el contenido original
          if (viewer._originalContent) {
            viewer.innerHTML = viewer._originalContent;
            // Reaplica el resaltado de sintaxis
            if (window.hljs) setTimeout(() => hljs.highlightAll(), 0);
          }
          
          lastTerm = term;
          
          // Usamos mark.js en lugar de nuestra propia implementación
          // pero aquí simularemos una implementación mejorada
          performSearch(term);
        } catch (error) {
          console.error("Error en búsqueda:", error);
          searchResults.style.display = 'none';
        } finally {
          isSearching = false;
        }
      }
    }

    function performSearch(term) {
      // Implementación mejorada de búsqueda
      try {
        // Escapa caracteres especiales de regex
        const escapedTerm = escapeRegExp(term);
        // Crea una expresión regular segura
        const regex = new RegExp(`(${escapedTerm})`, 'gi');
        
        // Usar un enfoque basado en innerHTML para documentos pequeños/medianos
        // Para documentos muy grandes, se recomendaría una biblioteca dedicada como mark.js
        markOccurrences(viewer, regex);
        
        // Recolectar todos los elementos resaltados
        highlights = Array.from(viewer.querySelectorAll('mark.highlight'));
        
        // Mostrar resultados si hay coincidencias
        if (highlights.length) {
          searchResults.style.display = 'flex';
          scrollHit(0);
        } else {
          searchResults.style.display = 'none';
          counter.textContent = '0 de 0';
        }
      } catch (error) {
        console.error("Error en búsqueda:", error);
        resetSearch();
      }
    }

    function markOccurrences(container, regex) {
      // Este enfoque preserva mejor la estructura del DOM
      const nodesWithText = [];
      
      // Busca nodos de texto recursivamente, evitando scripts y estilos
      function findTextNodes(node) {
        if (node.nodeType === Node.TEXT_NODE) {
          if (node.textContent.trim() && regex.test(node.textContent)) {
            nodesWithText.push(node);
          }
        } else if (node.nodeType === Node.ELEMENT_NODE) {
          // Evitar scripts, estilos y elementos ya marcados
          if (node.nodeName !== 'SCRIPT' && 
              node.nodeName !== 'STYLE' && 
              node.nodeName !== 'MARK') {
            for (let i = 0; i < node.childNodes.length; i++) {
              findTextNodes(node.childNodes[i]);
            }
          }
        }
      }
      
      findTextNodes(container);
      
      // Reemplazar texto en cada nodo encontrado
      for (const textNode of nodesWithText) {
        const parent = textNode.parentNode;
        const text = textNode.textContent;
        
        // Reiniciar lastIndex
        regex.lastIndex = 0;
        
        // Crear un fragmento para contener el nuevo contenido
        const fragment = document.createDocumentFragment();
        let lastIndex = 0;
        let match;
        
        while ((match = regex.exec(text)) !== null) {
          // Añadir texto antes de la coincidencia
          if (match.index > lastIndex) {
            fragment.appendChild(document.createTextNode(
              text.substring(lastIndex, match.index)
            ));
          }
          
          // Crear el elemento mark para resaltar
          const mark = document.createElement('mark');
          mark.className = 'highlight';
          mark.textContent = match[0];
          fragment.appendChild(mark);
          
          lastIndex = regex.lastIndex;
        }
        
        // Añadir cualquier texto restante
        if (lastIndex < text.length) {
          fragment.appendChild(document.createTextNode(
            text.substring(lastIndex)
          ));
        }
        
        // Reemplazar el nodo original con el fragmento
        parent.replaceChild(fragment, textNode);
      }
    }

    function scrollHit(idx) {
      if (highlights.length === 0) return;
      
      // Asegurar que el índice está dentro del rango válido
      current = (idx + highlights.length) % highlights.length;
      
      // Eliminar clase 'current' de todos los highlights
      highlights.forEach(h => h.classList.remove('current'));
      
      // Añadir clase 'current' al highlight actual
      highlights[current].classList.add('current');
      
      // Scroll suave al elemento
      highlights[current].scrollIntoView({
        behavior: 'smooth', 
        block: 'center'
      });
      
      // Actualizar contador
      counter.textContent = `${current + 1} de ${highlights.length}`;
    }

    function filterDocuments(term) {
      if (!term) {
        // Si no hay término, mostrar todos los documentos
        Array.from(docList.children).forEach(card => {
          card.style.display = '';
        });
        return;
      }
      
      const lower = term.toLowerCase();
      docList.style.display = 'grid';
      
      // Filtrar documentos por título
      Array.from(docList.children).forEach(card => {
        const title = card.querySelector('.doc-title').textContent.toLowerCase();
        card.style.display = title.includes(lower) ? '' : 'none';
      });
    }

    // Event Listeners
    document.getElementById('btn-back').onclick = () => {
      viewer.style.display = 'none';
      docToolbar.style.display = 'none';
      docList.style.display = 'grid';
      viewToolbar.style.display = 'flex';
      docTitleHeader.textContent = '';
      searchInput.value = '';
      resetSearch();
    };
    
    document.getElementById('btn-font-increase').onclick = () => changeFont(1);
    document.getElementById('btn-font-decrease').onclick = () => changeFont(-1);
    
    document.getElementById('grid-view-btn').onclick = () => {
      docList.className = 'doc-grid';
      document.getElementById('grid-view-btn').classList.add('active');
      document.getElementById('list-view-btn').classList.remove('active');
      localStorage.setItem('viewMode', 'grid');
    };
    
    document.getElementById('list-view-btn').onclick = () => {
      docList.className = 'doc-list';
      document.getElementById('list-view-btn').classList.add('active');
      document.getElementById('grid-view-btn').classList.remove('active');
      localStorage.setItem('viewMode', 'list');
    };
    
    prevBtn.onclick = () => scrollHit(current - 1);
    nextBtn.onclick = () => scrollHit(current + 1);
    
    closeBtn.onclick = () => {
      searchInput.value = '';
      resetSearch();
    };
    
    // Debounce para mejorar rendimiento en búsquedas
    searchInput.addEventListener('input', () => {
      clearTimeout(searchInput._t);
      searchInput._t = setTimeout(() => {
        if (viewer.style.display === 'block') {
          doSearch();
        } else {
          filterDocuments(searchInput.value);
        }
      }, 300);
    });
    
    // Permitir búsqueda con Enter
    searchInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') {
        if (viewer.style.display === 'block') {
          doSearch();
        } else {
          filterDocuments(searchInput.value);
        }
      }
    });
    
    // Inicialización
    document.addEventListener('DOMContentLoaded', () => {
      try {
        buildDocList();
        const viewMode = localStorage.getItem('viewMode');
        if (viewMode === 'list') {
          document.getElementById('list-view-btn').click();
        }
      } catch (error) {
        console.error("Error en inicialización:", error);
      }
    });
  </script>
</body>
</html>